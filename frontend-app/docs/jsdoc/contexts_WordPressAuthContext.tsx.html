

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> contexts/WordPressAuthContext.tsx</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="AvatarManager.html">AvatarManager</a></li></ul><h3>Interfaces</h3><ul><li><a href="APITestResult.html">APITestResult</a></li><li><a href="AvatarOptions.html">AvatarOptions</a></li><li><a href="HeaderProps.html">HeaderProps</a></li><li><a href="NotificationSettings.html">NotificationSettings</a></li><li><a href="ScheduleSettings.html">ScheduleSettings</a></li><li><a href="WordPressToken.html">WordPressToken</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AdSenseFeed">AdSenseFeed</a></li><li><a href="global.html#AdSenseWidget">AdSenseWidget</a></li><li><a href="global.html#AddToHomeScreen">AddToHomeScreen</a></li><li><a href="global.html#AuthStatus">AuthStatus</a></li><li><a href="global.html#AuthorDisplay">AuthorDisplay</a></li><li><a href="global.html#AuthorWidget">AuthorWidget</a></li><li><a href="global.html#Avatar">Avatar</a></li><li><a href="global.html#AvatarUpload">AvatarUpload</a></li><li><a href="global.html#AvatarUploadV2">AvatarUploadV2</a></li><li><a href="global.html#CategoryCards">CategoryCards</a></li><li><a href="global.html#CategoryCloud">CategoryCloud</a></li><li><a href="global.html#CategoryCloudEnhanced">CategoryCloudEnhanced</a></li><li><a href="global.html#CategoryList">CategoryList</a></li><li><a href="global.html#CategoryPills">CategoryPills</a></li><li><a href="global.html#CreativeCommonsWidget">CreativeCommonsWidget</a></li><li><a href="global.html#CustomHeader">CustomHeader</a></li><li><a href="global.html#DonateWidget">DonateWidget</a></li><li><a href="global.html#EnhancedAuthorWidget">EnhancedAuthorWidget</a></li><li><a href="global.html#Footer">Footer</a></li><li><a href="global.html#InteractiveButton">InteractiveButton</a></li><li><a href="global.html#KNOWN_LEGACY_MAPPINGS">KNOWN_LEGACY_MAPPINGS</a></li><li><a href="global.html#LoadMore">LoadMore</a></li><li><a href="global.html#OfflineIndicator">OfflineIndicator</a></li><li><a href="global.html#Pagination">Pagination</a></li><li><a href="global.html#PostCard">PostCard</a></li><li><a href="global.html#PostCardBig">PostCardBig</a></li><li><a href="global.html#PostGrid">PostGrid</a></li><li><a href="global.html#WORDPRESS_API_ENDPOINTS">WORDPRESS_API_ENDPOINTS</a></li><li><a href="global.html#WebringWidget">WebringWidget</a></li><li><a href="global.html#WordPressAuthProvider">WordPressAuthProvider</a></li><li><a href="global.html#calculateCategoryFontSize">calculateCategoryFontSize</a></li><li><a href="global.html#calculateNextRun">calculateNextRun</a></li><li><a href="global.html#calculateSimilarity">calculateSimilarity</a></li><li><a href="global.html#checkMultiplePostsLinks">checkMultiplePostsLinks</a></li><li><a href="global.html#checkPostLinks">checkPostLinks</a></li><li><a href="global.html#checkUrl">checkUrl</a></li><li><a href="global.html#clearStoredToken">clearStoredToken</a></li><li><a href="global.html#createExcerpt">createExcerpt</a></li><li><a href="global.html#createGravatarUrl">createGravatarUrl</a></li><li><a href="global.html#createScheduledCheck">createScheduledCheck</a></li><li><a href="global.html#createUrlParams">createUrlParams</a></li><li><a href="global.html#dataURLToBlob">dataURLToBlob</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#decodeHtmlEntities">decodeHtmlEntities</a></li><li><a href="global.html#downloadFile">downloadFile</a></li><li><a href="global.html#executeScheduledCheck">executeScheduledCheck</a></li><li><a href="global.html#exportDeadLinks">exportDeadLinks</a></li><li><a href="global.html#exportToCSV">exportToCSV</a></li><li><a href="global.html#exportToJSON">exportToJSON</a></li><li><a href="global.html#extractUrlsFromContent">extractUrlsFromContent</a></li><li><a href="global.html#findPostByLegacyUrl">findPostByLegacyUrl</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatNextRun">formatNextRun</a></li><li><a href="global.html#formatReadingTime">formatReadingTime</a></li><li><a href="global.html#formatRelativeDate">formatRelativeDate</a></li><li><a href="global.html#generateArchiveUrl">generateArchiveUrl</a></li><li><a href="global.html#generateAvatarSizes">generateAvatarSizes</a></li><li><a href="global.html#generateColorFromString">generateColorFromString</a></li><li><a href="global.html#generateInitialsAvatar">generateInitialsAvatar</a></li><li><a href="global.html#generatePDFHTML">generatePDFHTML</a></li><li><a href="global.html#generatePDFReport">generatePDFReport</a></li><li><a href="global.html#generateRandomState">generateRandomState</a></li><li><a href="global.html#generateSlug">generateSlug</a></li><li><a href="global.html#generateSlugVariations">generateSlugVariations</a></li><li><a href="global.html#generateSuggestions">generateSuggestions</a></li><li><a href="global.html#generateTestReport">generateTestReport</a></li><li><a href="global.html#getAuthStatus">getAuthStatus</a></li><li><a href="global.html#getDefaultExportOptions">getDefaultExportOptions</a></li><li><a href="global.html#getDefaultNotificationSettings">getDefaultNotificationSettings</a></li><li><a href="global.html#getDefaultScheduleSettings">getDefaultScheduleSettings</a></li><li><a href="global.html#getFeaturedImageUrl">getFeaturedImageUrl</a></li><li><a href="global.html#getInitials">getInitials</a></li><li><a href="global.html#getKnownMapping">getKnownMapping</a></li><li><a href="global.html#getLocalStorage">getLocalStorage</a></li><li><a href="global.html#getPostAuthor">getPostAuthor</a></li><li><a href="global.html#getPostAuthorId">getPostAuthorId</a></li><li><a href="global.html#getPostCategories">getPostCategories</a></li><li><a href="global.html#getPostTags">getPostTags</a></li><li><a href="global.html#getReadingTime">getReadingTime</a></li><li><a href="global.html#getScheduledChecks">getScheduledChecks</a></li><li><a href="global.html#getStoredToken">getStoredToken</a></li><li><a href="global.html#handleOAuthCallback">handleOAuthCallback</a></li><li><a href="global.html#initiateWordPressOAuth">initiateWordPressOAuth</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#isBrowser">isBrowser</a></li><li><a href="global.html#isDebugMode">isDebugMode</a></li><li><a href="global.html#isValidEmail">isValidEmail</a></li><li><a href="global.html#loadAvatarFromStorage">loadAvatarFromStorage</a></li><li><a href="global.html#loadNotificationSettings">loadNotificationSettings</a></li><li><a href="global.html#loadScheduleSettings">loadScheduleSettings</a></li><li><a href="global.html#logAPIResponse">logAPIResponse</a></li><li><a href="global.html#makeAuthenticatedRequest">makeAuthenticatedRequest</a></li><li><a href="global.html#processNotifications">processNotifications</a></li><li><a href="global.html#removeAvatarFromStorage">removeAvatarFromStorage</a></li><li><a href="global.html#requestNotificationPermission">requestNotificationPermission</a></li><li><a href="global.html#resizeImageToSquare">resizeImageToSquare</a></li><li><a href="global.html#saveAvatarToStorage">saveAvatarToStorage</a></li><li><a href="global.html#saveNotificationSettings">saveNotificationSettings</a></li><li><a href="global.html#saveScheduleSettings">saveScheduleSettings</a></li><li><a href="global.html#searchArchiveSnapshots">searchArchiveSnapshots</a></li><li><a href="global.html#sendEmailNotification">sendEmailNotification</a></li><li><a href="global.html#sendWebhookNotification">sendWebhookNotification</a></li><li><a href="global.html#setLocalStorage">setLocalStorage</a></li><li><a href="global.html#shouldRunCheck">shouldRunCheck</a></li><li><a href="global.html#showBrowserNotification">showBrowserNotification</a></li><li><a href="global.html#storeToken">storeToken</a></li><li><a href="global.html#stripHtml">stripHtml</a></li><li><a href="global.html#testEndpoint">testEndpoint</a></li><li><a href="global.html#testWordPressEndpoints">testWordPressEndpoints</a></li><li><a href="global.html#truncateText">truncateText</a></li><li><a href="global.html#updateScheduleSettings">updateScheduleSettings</a></li><li><a href="global.html#useAuthenticatedAPI">useAuthenticatedAPI</a></li><li><a href="global.html#useClientOnly">useClientOnly</a></li><li><a href="global.html#useClientState">useClientState</a></li><li><a href="global.html#useWordPressAuth">useWordPressAuth</a></li><li><a href="global.html#validateImageFile">validateImageFile</a></li><li><a href="global.html#validateSiteSetup">validateSiteSetup</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>contexts/WordPressAuthContext.tsx</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use client';

import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { 
  initiateWordPressOAuth, 
  handleOAuthCallback, 
  getAuthStatus, 
  clearStoredToken,
  getStoredToken
} from '@/utils/wordpressImplicitAuth';

// Types
interface WordPressToken {
  accessToken: string;
  tokenType: string;
  expiresIn: number;
  scope: string;
  siteId: string;
  state: string;
  expiresAt: Date;
}

interface WordPressUser {
  id: number;
  name: string;
  email?: string;
  avatar_url?: string;
  roles?: string[];
}

interface WordPressAuthState {
  isAuthenticated: boolean;
  token: WordPressToken | null;
  user: WordPressUser | null;
  permissions: string[];
  loading: boolean;
  error: string | null;
  siteId: string | null;
}

interface WordPressAuthActions {
  login: () => Promise&lt;void>;
  logout: () => void;
  refreshToken: () => Promise&lt;void>;
  checkPermission: (scope: string) => boolean;
  clearError: () => void;
}

interface WordPressAuthContextType extends WordPressAuthState, WordPressAuthActions {}

// Context
const WordPressAuthContext = createContext&lt;WordPressAuthContextType | undefined>(undefined);

// Provider Props
interface WordPressAuthProviderProps {
  children: ReactNode;
}

/**
 * WordPress.com Authentication Context Provider Component
 *
 * This provider component manages the authentication state for WordPress.com OAuth.
 * It handles the OAuth flow, token storage, and provides authentication methods
 * to child components through React Context.
 *
 * @param {WordPressAuthProviderProps} props - Component props
 * @returns {JSX.Element} Context provider wrapping children
 *
 * @example
 * ```tsx
 * import { WordPressAuthProvider } from '@/contexts/WordPressAuthContext';
 *
 * function App() {
 *   return (
 *     &lt;WordPressAuthProvider>
 *       &lt;MyApp />
 *     &lt;/WordPressAuthProvider>
 *   );
 * }
 * ```
 */
export function WordPressAuthProvider({ children }: WordPressAuthProviderProps) {
  const [state, setState] = useState&lt;WordPressAuthState>({
    isAuthenticated: false,
    token: null,
    user: null,
    permissions: [],
    loading: true,
    error: null,
    siteId: null
  });

  // Initialize authentication state
  useEffect(() => {
    initializeAuth();
  }, []);

  // Check for OAuth callback on page load
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const authResult = handleOAuthCallback();
    if (authResult.isAuthenticated &amp;&amp; authResult.token) {
      console.log('ðŸŽ‰ WordPress.com OAuth successful via context!');
      updateAuthState(authResult.token);
    } else if (authResult.error) {
      setState(prev => ({ ...prev, error: authResult.error!, loading: false }));
    }
  }, []);

  const initializeAuth = async () => {
    try {
      const currentAuth = getAuthStatus();
      if (currentAuth.isAuthenticated &amp;&amp; currentAuth.token) {
        await updateAuthState(currentAuth.token);
      } else {
        setState(prev => ({ ...prev, loading: false }));
      }
    } catch (error) {
      console.error('Error initializing auth:', error);
      setState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error instanceof Error ? error.message : 'Authentication initialization failed'
      }));
    }
  };

  const updateAuthState = async (token: WordPressToken) => {
    try {
      // Parse permissions from token scope
      const permissions = token.scope ? token.scope.split(',') : [];
      
      // TODO: Fetch user data with token
      const user: WordPressUser = {
        id: 1,
        name: 'David Robert Lewis', // Fallback - will be fetched from API later
        avatar_url: '/images/avatar.png'
      };

      setState({
        isAuthenticated: true,
        token,
        user,
        permissions,
        loading: false,
        error: null,
        siteId: token.siteId
      });

      console.log('âœ… WordPress.com authentication state updated:', {
        siteId: token.siteId,
        permissions,
        expiresAt: token.expiresAt
      });

    } catch (error) {
      console.error('Error updating auth state:', error);
      setState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error instanceof Error ? error.message : 'Failed to update authentication'
      }));
    }
  };

  const login = async () => {
    try {
      setState(prev => ({ ...prev, loading: true, error: null }));
      initiateWordPressOAuth();
    } catch (error) {
      console.error('Login error:', error);
      setState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error instanceof Error ? error.message : 'Login failed'
      }));
    }
  };

  const logout = () => {
    clearStoredToken();
    setState({
      isAuthenticated: false,
      token: null,
      user: null,
      permissions: [],
      loading: false,
      error: null,
      siteId: null
    });
    console.log('ðŸšª WordPress.com logout successful');
  };

  const refreshToken = async () => {
    try {
      setState(prev => ({ ...prev, loading: true }));
      
      // Check if current token is still valid
      const currentToken = getStoredToken();
      if (currentToken &amp;&amp; new Date() &lt; new Date(currentToken.expiresAt)) {
        await updateAuthState(currentToken);
        return;
      }

      // Token expired - need to re-authenticate
      logout();
      throw new Error('Token expired - please re-authenticate');

    } catch (error) {
      console.error('Token refresh error:', error);
      setState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error instanceof Error ? error.message : 'Token refresh failed'
      }));
    }
  };

  const checkPermission = (scope: string): boolean => {
    return state.permissions.includes(scope) || state.permissions.includes('read') || state.permissions.includes('write');
  };

  const clearError = () => {
    setState(prev => ({ ...prev, error: null }));
  };

  const contextValue: WordPressAuthContextType = {
    ...state,
    login,
    logout,
    refreshToken,
    checkPermission,
    clearError
  };

  return (
    &lt;WordPressAuthContext.Provider value={contextValue}>
      {children}
    &lt;/WordPressAuthContext.Provider>
  );
}

/**
 * Custom hook to access WordPress.com authentication context
 *
 * This hook provides access to the WordPress.com authentication state and methods.
 * Must be used within a WordPressAuthProvider component.
 *
 * @returns {WordPressAuthContextType} Authentication context with state and methods
 * @throws {Error} If used outside of WordPressAuthProvider
 *
 * @example
 * ```tsx
 * import { useWordPressAuth } from '@/contexts/WordPressAuthContext';
 *
 * function MyComponent() {
 *   const { isAuthenticated, login, logout, user } = useWordPressAuth();
 *
 *   if (!isAuthenticated) {
 *     return &lt;button onClick={login}>Login with WordPress.com&lt;/button>;
 *   }
 *
 *   return (
 *     &lt;div>
 *       &lt;p>Welcome, {user?.name}!&lt;/p>
 *       &lt;button onClick={logout}>Logout&lt;/button>
 *     &lt;/div>
 *   );
 * }
 * ```
 */
export function useWordPressAuth(): WordPressAuthContextType {
  const context = useContext(WordPressAuthContext);
  if (context === undefined) {
    throw new Error('useWordPressAuth must be used within a WordPressAuthProvider');
  }
  return context;
}

/**
 * TypeScript type definitions for WordPress.com authentication
 */

/**
 * WordPress.com OAuth token structure
 * @typedef {Object} WordPressToken
 * @property {string} accessToken - The OAuth access token
 * @property {string} tokenType - Token type (usually 'bearer')
 * @property {number} expiresIn - Token expiration time in seconds
 * @property {string} scope - Granted OAuth scopes
 * @property {string} siteId - WordPress.com site ID
 * @property {string} state - OAuth state parameter for CSRF protection
 * @property {Date} expiresAt - Token expiration timestamp
 */

/**
 * WordPress.com user information structure
 * @typedef {Object} WordPressUser
 * @property {number} id - User ID
 * @property {string} name - Display name
 * @property {string} [email] - User email (if available)
 * @property {string} [avatar_url] - User avatar URL
 * @property {string[]} [roles] - User roles
 */

/**
 * WordPress.com authentication state structure
 * @typedef {Object} WordPressAuthState
 * @property {boolean} isAuthenticated - Whether user is authenticated
 * @property {WordPressToken|null} token - Current authentication token
 * @property {WordPressUser|null} user - Current user information
 * @property {string[]} permissions - Array of granted permissions
 * @property {boolean} loading - Whether authentication is loading
 * @property {string|null} error - Authentication error message
 * @property {string|null} siteId - Current site ID
 */

// Export types for use in other components
export type { WordPressToken, WordPressUser, WordPressAuthState };</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun Aug 31 2025 10:28:25 GMT-0400 (Eastern Daylight Time)</p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
